# Post Pages Migration Guide

**Last Updated**: 2025-12-01  
**Status**: MVP Complete (Phase 3 - User Story 1)  
**Script**: `scripts/migrations/migrate-posts.js`

## Overview

This guide covers migrating post pages (including events and project results) from Wix CSV export to Builder.io using the migration script. The script handles field transformation, reference resolution, duplicate prevention, and provides comprehensive progress tracking.

---

## Prerequisites

### Required Files

1. **CSV Export**: `data/exports/Posts_Events_Project+Results+Pages_wix.csv`

   - Contains all post pages from Wix including events and project results
   - Must have required columns: `ID`, `Title`, `Slug`, `pageTypes`, etc.

2. **Tag Mapping**: `data/mappings/tag-migration-mapping.json`

   - Generated by `scripts/migrations/migrate-tags.js`
   - Required for resolving references to tags, people, projects, organisations

3. **API Key**: `.env.local` with `BUILDER_PRIVATE_API_KEY`
   - Get from: https://builder.io/account/space
   - Must have write permissions for `post-page` model

### Dependencies

```bash
npm install
# Requires: dotenv, node-fetch@2.7.0, csv-parse
```

---

## Basic Usage

### Migrate Posts

```bash
# Migrate first 10 posts (recommended for testing)
node scripts/migrations/migrate-posts.js 10

# Migrate first 50 posts
node scripts/migrations/migrate-posts.js 50

# Migrate ALL posts
node scripts/migrations/migrate-posts.js all
```

### Show Help

```bash
# Display usage information
node scripts/migrations/migrate-posts.js
```

---

## CSV Format

The script expects a CSV file with the following key columns:

### Required Fields

- `ID` - Wix post ID (preserved as `wixId` in Builder.io)
- `Title` - Post title (**Note**: Capital 'T')
- `Slug` - URL slug (will be prefixed with `/post/`) (**Note**: Capital 'S')
- `pageTypes` - JSON array of type IDs (determines sub-type: post/event/project-result)

### Optional Fields

- `subtitle` - Post subtitle
- `Author` - JSON array of author IDs
- `pageOwner` - JSON array of page owner IDs
- `people`, `methods`, `domains`, `projects`, `organisations` - JSON arrays of related entity IDs
- `Post Content 1-10` - Rich text content sections
- `Post Image 1-10` - Image URLs
- `eventRegistration`, `eventStartDate`, `eventEndDate`, `speakers`, `moderators` - Event-specific fields
- `projectResultAuthor`, `Project Result Media`, `projectResultPublicationDate` - Project result fields
- `internalLinks`, `Media Files` - Additional content
- `countryTag` - Country tag ID
- `recomendations` - Recommendation count

### Example CSV Row (simplified)

**Note**: CSV column names are case-sensitive. Use exact names: `Title`, `Slug`, `ID`, `Author`, etc.

```csv
ID,Title,Slug,pageTypes,Author
"abc123","Future of AI","future-of-ai-2024","[""649a0649-abfd-43c3-86d5-2765c99f7f31""]","[""d5357589-65fd-456f-a506-7a4d1275451c""]"
```

---

## Field Mapping

### Basic Fields

| Wix CSV Column | Builder.io Path | Transformation         |
| -------------- | --------------- | ---------------------- |
| `Title`        | `data.title`    | Direct                 |
| `subtitle`     | `data.subtitle` | Direct                 |
| `Slug`         | `data.slug`     | Add `/post/` prefix    |
| `ID`           | `data.wixId`    | Preserved for tracking |

### Metadata

| Wix CSV Column | Builder.io Path | Transformation            |
| -------------- | --------------- | ------------------------- |
| `Created Date` | `createdDate`   | Convert to timestamp (ms) |
| `Updated Date` | `lastUpdated`   | Convert to timestamp (ms) |
| -              | `published`     | Set to "published"        |
| `Owner`        | `createdBy`     | Builder.io user ID        |

### Content (Rich Text & Images)

- `Post Content 1-10` → `data.postContentRIch1-10` (HTML/rich text)
- `Post Image 1-10` → `data.postImage1-10` (image objects, parsed from JSON)

**Note**: Image fields in CSV contain JSON strings like `{"url":"...","caption":"..."}` which are automatically parsed into objects.

### References

All reference fields are resolved via `tag-migration-mapping.json`:

| Wix CSV Column  | Builder.io Path        | Wrapper Key         |
| --------------- | ---------------------- | ------------------- |
| `Author`        | `data.author[]`        | `authorItem`        |
| `pageOwner`     | `data.pageOwner[]`     | `pageOwnerItem`     |
| `people`        | `data.people[]`        | `peopleItem`        |
| `methods`       | `data.methods[]`       | `methodsItem`       |
| `domains`       | `data.domains[]`       | `domainsItem`       |
| `projects`      | `data.projects[]`      | `projectsItem`      |
| `organisations` | `data.organisations[]` | `organisationsItem` |
| `pageTypes`     | `data.pageTypes[]`     | `pageTypeItem`      |
| `countryTag`    | `data.countryTag`      | (single reference)  |

### Event-Specific Fields

- `speakers` → `data.speakers[]` (references)
- `moderators` → `data.moderators[]` (references)
- `eventRegistration` → `data.eventRegistration` (URL)
- `eventStartDate` → `data.eventStartDate` (timestamp)
- `eventEndDate` → `data.eventEndDate` (timestamp)

### Project Result-Specific Fields

- `projectResultAuthor` → `data.projectResultAuthor[]` (references)
- `Project Result Media` → `data.projectResultMedia` (media object, parsed from JSON)
- `projectResultPublicationDate` → `data.projectResultPublicationDate` (timestamp)

**Note**: `Project Result Media` contains JSON strings like `{"displayName":"...","url":"...","fileName":"...","thumbnail":"...","sizeInBytes":"...","type":"document"}` which are automatically parsed into complete media objects.

---

## Migration Behavior

### Duplicate Prevention

- Script checks `data/mappings/post-migration-mapping.json` before migrating each post
- Posts with Wix IDs already in the mapping are automatically skipped
- Re-running the script is safe and will only migrate new posts

### Slug Collision Handling

- Script queries Builder.io to check if slug already exists
- If collision detected, automatically appends numeric suffix: `-2`, `-3`, etc.
- Collision is logged for administrator review

### Reference Resolution

- All Wix IDs are resolved to Builder.io IDs via `tag-migration-mapping.json`
- Missing references are omitted from reference arrays and logged as warnings
- Posts are still migrated even if some references are missing

### Required Field Validation

- Posts missing `title` or `slug` are skipped entirely
- Skipped posts are logged with details of missing fields
- Can be fixed in source CSV and re-migrated

### Rate Limiting

- Default: 200ms delay between API calls
- Prevents Builder.io API rate limiting
- Configurable via `RATE_LIMIT` constant in script

---

## Migration Mapping File

**Location**: `data/mappings/post-migration-mapping.json`

### Structure

```json
{
  "wixToBuilder": {
    "abc123": {
      "builderId": "xyz789",
      "title": "Future of AI",
      "slug": "/post/future-of-ai-2024"
    }
  },
  "builderToWix": {
    "xyz789": "abc123"
  },
  "migratedCount": 150,
  "lastMigrated": "2025-12-01T12:34:56.789Z"
}
```

### Usage

- **Lookup Builder.io ID** from Wix ID: `mapping.wixToBuilder[wixId].builderId`
- **Lookup Wix ID** from Builder.io ID: `mapping.builderToWix[builderId]`
- **Check if migrated**: `!!mapping.wixToBuilder[wixId]`

---

## Common Scenarios

### Test Migration (10 posts)

```bash
# Migrate first 10 posts
node scripts/migrations/migrate-posts.js 10

# Expected output:
# ✓ Found 3088 posts in CSV
# ℹ Migrating 10 posts...
# ✓ [1/10] Created: Post Title (ID: xyz123)
# ...
# ✓ Successfully migrated: 10 posts
```

### Resume After Interruption

```bash
# Start migration
node scripts/migrations/migrate-posts.js 100

# Press Ctrl+C to interrupt after 50 posts

# Resume - script automatically skips the 50 already migrated
node scripts/migrations/migrate-posts.js 100

# Expected output:
# ⚠ [1/100] Skipping Post 1 (already migrated)
# ...
# ⚠ [50/100] Skipping Post 50 (already migrated)
# ✓ [51/100] Created: Post 51 (ID: xyz123)
```

### Migrate All Posts

```bash
# Production migration
node scripts/migrations/migrate-posts.js all

# Expected:
# - Takes several hours for thousands of posts
# - Progress saved after each successful migration
# - Can be safely interrupted and resumed
```

---

## Troubleshooting

### "API key not found in .env.local"

**Solution**: Add `BUILDER_PRIVATE_API_KEY` to `.env.local`

```env
BUILDER_PRIVATE_API_KEY=your-private-api-key-here
```

### "Tag mapping file not found"

**Solution**: Run tag migration first

```bash
node scripts/migrations/migrate-tags.js all
```

### "CSV file not found"

**Solution**: Export posts from Wix and place at:

```
data/exports/Posts_Events_Project+Results+Pages_wix.csv
```

### Missing References Warning

```
⚠ Post abc123: Missing reference author:xyz789
```

**Cause**: Referenced entity (tag) doesn't exist in Builder.io  
**Impact**: Post is still migrated, but without that specific reference  
**Solution**: Verify tag migration completed successfully, or add missing tag manually

### Duplicate Slug

```
⚠ Slug collision: /post/my-post -> /post/my-post-2
```

**Cause**: Multiple posts with same slug  
**Impact**: Duplicate posts get auto-suffixed  
**Solution**: Review slugs in source CSV to ensure uniqueness

### Missing Required Fields

```
✗ [5/100] Skipping Post 5: Missing required fields: Title, Slug
```

**Cause**: Post missing `Title` or `Slug` in CSV (case-sensitive column names)  
**Impact**: Post skipped entirely  
**Solution**: Add missing fields to CSV and re-run migration

**Note**: The script validates for `Title` and `Slug` with capital letters matching the CSV headers

---

## Next Steps

### Phase 3 Complete ✅

- ✅ Core migration functionality
- ✅ Field transformation (40+ fields)
- ✅ Reference resolution
- ✅ Duplicate prevention
- ✅ Error handling
- ✅ Summary reporting

### Upcoming Features (Phase 4-7)

- **Phase 4**: Progress tracking with ETA calculation
- **Phase 5**: Dry-run mode for testing
- **Phase 6**: Validation mode (compare migrated vs source)
- **Phase 7**: Enhanced documentation and testing

---

## Support

For issues or questions:

1. Check this guide's troubleshooting section
2. Review migration mapping file for status
3. Check Builder.io console for created posts
4. Review script console output for warnings/errors

---

**Generated by**: `/speckit.implement` command  
**Feature**: Post Pages Migration (001-migrate-post-pages)  
**Documentation**: This guide will be enhanced in Phase 7
