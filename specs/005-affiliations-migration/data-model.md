# Data Model: Affiliations Migration

**Feature**: 005-affiliations-migration  
**Date**: 2024-12-04

## Entities

### 1. Affiliation (Builder.io Model)

**Model Name**: `affiliations`  
**Model ID**: `cda5281bf4f9491490eca792af06b25b`  
**Kind**: data

Represents a relationship between entities (person, organisation, project) in the Futures4Europe platform.

#### Fields

| Field                  | Type      | Required | Description                                                               |
| ---------------------- | --------- | -------- | ------------------------------------------------------------------------- |
| `title`                | text      | No       | Display name describing the affiliation (e.g., "John Doe -to- Project X") |
| `projectTag`           | reference | No       | Reference to a project tag in the `tag` model                             |
| `organisationTag`      | reference | No       | Reference to an organisation tag in the `tag` model                       |
| `extraOrganisationTag` | reference | No       | Reference to an additional organisation tag                               |
| `personTag`            | reference | No       | Reference to a person tag in the `tag` model                              |
| `role`                 | text      | No       | Text describing the role in the relationship                              |
| `extraIdentifier`      | text      | No       | Additional identifier (e.g., "current", "former", "participation")        |

#### Reference Configuration

All reference fields point to the `tag` model:

- **Model ID**: `a275c515afdb401b8b06f9fafe9bcbce`
- **Reference Format**:

```json
{
  "@type": "@builder.io/core:Reference",
  "id": "<builder_tag_id>",
  "model": "tag"
}
```

#### Data Object Structure (in Builder.io)

```typescript
interface BuilderAffiliation {
  id: string; // Builder.io content ID
  name: string; // Content entry name (same as title)
  published: "published" | "draft";
  createdDate: number; // Unix timestamp (ms)
  lastUpdated: number; // Unix timestamp (ms)
  data: {
    title: string;
    projectTag?: BuilderReference;
    organisationTag?: BuilderReference;
    extraOrganisationTag?: BuilderReference;
    personTag?: BuilderReference;
    role?: string;
    extraIdentifier?: string;
    wixId?: string; // Original Wix ID (for migration reference)
  };
}

interface BuilderReference {
  "@type": "@builder.io/core:Reference";
  id: string;
  model: string;
}
```

---

### 2. Affiliation Mapping Entry

Stored in `data/mappings/affiliation-migration-mapping.json` (generated by migration script).

Records the relationship between Wix and Builder.io IDs for migrated affiliations.

#### Structure

```typescript
interface AffiliationMappingFile {
  wixToBuilder: {
    [wixId: string]: AffiliationMappingEntry;
  };
  builderToWix: {
    [builderId: string]: string; // Reverse lookup
  };
  migratedCount: number;
  lastMigrated: string; // ISO timestamp
  stats: {
    total: number;
    successful: number;
    failed: number;
    skipped: number;
    missingTagReferences: number;
  };
}

interface AffiliationMappingEntry {
  builderId: string;
  title: string;
  migratedAt: string; // ISO timestamp
}
```

---

### 3. Wix Affiliation (Source Format)

CSV structure from `data/exports/Affiliations_wix.csv`.

| Column                 | Type          | Example                                               |
| ---------------------- | ------------- | ----------------------------------------------------- |
| `Title`                | string        | "John Doe -to- Project X"                             |
| `Created Date`         | ISO timestamp | "2025-01-24T14:23:45Z"                                |
| `projectTag`           | UUID (Wix ID) | "f02c006f-7cc4-4cdc-9134-640b7ea6bfcb"                |
| `organisationTag`      | UUID (Wix ID) | "8b50d097-dd4c-4021-aed3-f7ff330adf55"                |
| `personTag`            | UUID (Wix ID) | "7761c491-0adc-4c2f-aa91-599a3699f3fa"                |
| `extraOrganisationTag` | UUID (Wix ID) | "" (often empty)                                      |
| `role`                 | string        | "" (often empty)                                      |
| `extraIdentifier`      | string        | "current", "participation", "projectOrganisationRole" |
| `ID`                   | UUID (Wix ID) | "002bef30-d76d-4423-9045-91d5f29ca3ab"                |
| `Updated Date`         | ISO timestamp | "2025-01-24T14:23:45Z"                                |
| `Owner`                | string        | "" (typically empty)                                  |

---

### 4. Wix-Compatible Affiliation (Response Format)

Format returned by `/api/affiliations` for backwards compatibility.

```typescript
interface WixCompatibleAffiliation {
  data: {
    title: string;
    projectTag?: string; // Builder.io tag ID
    organisationTag?: string; // Builder.io tag ID
    extraOrganisationTag?: string; // Builder.io tag ID
    personTag?: string; // Builder.io tag ID
    role?: string;
    extraIdentifier?: string;
    _id?: string; // Builder.io affiliation ID
    _createdDate?: { $date: string };
    _updatedDate?: { $date: string };
  };
}
```

---

## Relationships

```
┌─────────────────┐       ┌─────────────────┐
│   Affiliation   │       │      Tag        │
│  (Builder.io)   │       │  (Builder.io)   │
├─────────────────┤       ├─────────────────┤
│ id              │       │ id              │
│ title           │       │ name            │
│ projectTag ─────┼──────>│ tagType         │
│ organisationTag ┼──────>│ tagLine         │
│ personTag ──────┼──────>│ picture         │
│ extraOrgTag ────┼──────>│ tagPageLink     │
│ role            │       │ masterTag       │
│ extraIdentifier │       │ wixId           │
│ wixId           │       └─────────────────┘
└─────────────────┘

Notes:
- All 4 tag reference fields point to the same `tag` model
- Each tag can be referenced by multiple affiliations
- An affiliation typically has 2-3 tag references (not all 4)
```

---

## Validation Rules

### Affiliation Creation (Migration)

1. **Title**: Required, non-empty string
2. **Tag References**:
   - Each Wix tag ID must exist in `tag-migration-mapping.json`
   - Missing mappings result in null reference (with warning)
   - Malformed values (JSON objects) are treated as null
3. **Wix ID**: Must be unique (deduplicated by mapping file)

### Affiliation Fetch (API)

1. **Pagination**: Required for Builder.io (100 items per page)
2. **Response Format**: Must match Wix `{ data: { ... } }` wrapper
3. **Reference Resolution**: Tag IDs must be Builder.io IDs (not Wix IDs)

---

## State Transitions

### Migration State

```
CSV Record
    │
    ├──[Parse]──> Wix Format
    │                │
    │                ├──[Check Mapping]──> Already Migrated? ──> SKIP
    │                │
    │                ├──[Transform]──> Builder.io Payload
    │                │                       │
    │                │                       ├──[Create]──> SUCCESS
    │                │                       │              (Update mapping)
    │                │                       │
    │                │                       └──[API Error]──> FAILED
    │                │                                        (Log, continue)
    │                │
    │                └──[Invalid Data]──> WARNING (create with nulls)
    │
    └──[Parse Error]──> FAILED (log, continue)
```

### Cache State

```
                    ┌─────────────────┐
                    │   Cache Miss    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ Fetch Builder.io│
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   Transform     │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Save to Redis  │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Return Data    │
                    └─────────────────┘
```
