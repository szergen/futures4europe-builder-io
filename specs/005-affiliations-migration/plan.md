# Implementation Plan: Affiliations Migration

**Branch**: `005-affiliations-migration` | **Date**: 2024-12-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-affiliations-migration/spec.md`

## Summary

Migrate affiliations data from Wix CSV export to Builder.io and switch the application to fetch affiliations from Builder.io instead of Wix. The migration script follows the established pattern from `migrate-tags.js`, transforming Wix tag reference IDs to Builder.io tag IDs using the existing mapping file. Phase 1 (P1) handles data migration, Phase 2 (P2) updates the application to use Builder.io as the source of truth.

## Technical Context

**Language/Version**: Node.js 18+, TypeScript 5.x (Next.js 14)  
**Primary Dependencies**: `@builder.io/sdk`, `csv-parse`, `node-fetch`, `dotenv`  
**Storage**: Builder.io CMS (affiliations model), Redis (Upstash) for caching  
**Testing**: Manual verification + sample spot-checks (E2E tests exist for broader coverage)  
**Target Platform**: Node.js CLI (P1), Next.js API Routes (P2)  
**Project Type**: Web application (Next.js)  
**Performance Goals**: Migration under 30 minutes, API response under 3 seconds  
**Constraints**: 200ms rate limiting between API calls, backwards-compatible response format  
**Scale/Scope**: ~1,826 affiliations, 4 tag reference fields per affiliation

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                             | Status  | Notes                                                                |
| ------------------------------------- | ------- | -------------------------------------------------------------------- |
| I. Migration-First Development        | ✅ PASS | Feature is part of Wix → Builder.io migration                        |
| II. Content Type Parity               | ✅ PASS | Affiliations follow same pattern as tags migration                   |
| III. Backward Compatibility           | ✅ PASS | Response format transformation preserves `{ data: { ... } }` wrapper |
| IV. Data Integrity & Validation       | ✅ PASS | Incremental saves, summary report, sample verification               |
| V. Documentation & Migration Tracking | ✅ PASS | Script in `scripts/migrations/`, mapping in `data/mappings/`         |
| VI. Performance & Caching             | ✅ PASS | Redis caching maintained for affiliations                            |
| VII. Testing & Quality Assurance      | ✅ PASS | Verification mode, sample spot-checks                                |

**Constitution Re-check Post-Design**: All gates passed.

## Project Structure

### Documentation (this feature)

```text
specs/005-affiliations-migration/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
│   └── builder-affiliations-api.md
└── tasks.md             # Phase 2 output (created by /speckit.tasks)
```

### Source Code (repository root)

```text
# Phase 1 - Migration Script
scripts/
└── migrations/
    └── migrate-affiliations.js    # NEW: Migration CLI script

data/
├── exports/
│   └── Affiliations_wix.csv       # EXISTS: Source data
└── mappings/
    ├── tag-migration-mapping.json  # EXISTS: Tag ID mappings
    └── affiliation-migration-mapping.json  # NEW: Generated by migration

# Phase 2 - Application Updates
app/
├── api/
│   └── affiliations/
│       └── route.ts               # UPDATE: Switch to Builder.io
├── services/
│   └── cacheWarmer.ts             # UPDATE: Use Builder.io affiliations
├── utils/
│   └── builderAffiliationUtils.ts # NEW: Affiliation utilities
└── custom-hooks/
    └── useFetchAffiliations.tsx   # NO CHANGE: Uses /api/affiliations
```

**Structure Decision**: Follows existing project organization with migration script in `scripts/migrations/`, mapping output in `data/mappings/`, and utility functions in `app/utils/`.

## Complexity Tracking

> No constitution violations requiring justification.

| Item                | Complexity | Justification                            |
| ------------------- | ---------- | ---------------------------------------- |
| Migration Script    | Low        | Direct port of `migrate-tags.js` pattern |
| Reference Mapping   | Medium     | 4 reference fields vs 1 for tags         |
| API Endpoint Update | Low        | Same pattern as existing tag utilities   |
